<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Tile Cribbage Game</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        text-align: center;
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 500px;
      }
      h1 {
        color: #333;
        margin-top: 0;
      }
      p {
        color: #666;
        line-height: 1.6;
      }
      .code {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
        font-family: monospace;
        margin: 20px 0;
      }
      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        margin: 10px 5px;
      }
      button:hover {
        background: #764ba2;
      }
      button:active {
        transform: scale(0.98);
      }
      .status {
        margin-top: 20px;
        padding: 12px;
        border-radius: 6px;
        display: none;
      }
      .status.loading {
        display: block;
        background: #e3f2fd;
        color: #1976d2;
      }
      .status.error {
        display: block;
        background: #ffebee;
        color: #c62828;
      }
      .status.success {
        display: block;
        background: #e8f5e9;
        color: #2e7d32;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Tile Cribbage</h1>
      <p>Ready to join a game!</p>
      <div class="code" id="gameCode">Loading...</div>
      <button id="openAppBtn">Open in App</button>
      <button id="playWebBtn" style="display: none;">Play on Web</button>
      <button id="copyCodeBtn">Copy Game Code</button>
      <div class="status" id="status"></div>
      <p style="font-size: 14px; color: #999;">
        <span id="appInstalledMsg">If the app didn't open automatically, tap "Open in App" above.</span>
        <span id="appNotInstalledMsg" style="display: none;">
          Tile Cribbage is not installed on this device.
          <a href="https://play.google.com/store/apps/details?id=dev.mmay.tilecribbage" target="_blank">
            Download from Google Play
          </a>
        </span>
      </p>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const gameCode = urlParams.get('code');
      const statusEl = document.getElementById('status');
      const gameCodeEl = document.getElementById('gameCode');
      const openAppBtn = document.getElementById('openAppBtn');
      const playWebBtn = document.getElementById('playWebBtn');
      const copyCodeBtn = document.getElementById('copyCodeBtn');
      const appInstalledMsg = document.getElementById('appInstalledMsg');
      const appNotInstalledMsg = document.getElementById('appNotInstalledMsg');

      // Display the game code
      if (gameCode) {
        gameCodeEl.textContent = gameCode;
      } else {
        gameCodeEl.textContent = 'No game code provided';
        gameCodeEl.style.color = '#999';
      }

      // Detect if device is mobile
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      // Copy code to clipboard
      copyCodeBtn.addEventListener('click', () => {
        if (gameCode) {
          navigator.clipboard.writeText(gameCode).then(() => {
            statusEl.textContent = 'Game code copied to clipboard!';
            statusEl.className = 'status success';
            setTimeout(() => {
              statusEl.className = 'status';
            }, 3000);
          });
        }
      });

      // Play on web button
      playWebBtn.addEventListener('click', () => {
        redirectToWebApp();
      });

      // Try to open the app
      openAppBtn.addEventListener('click', () => {
        if (!gameCode) {
          statusEl.textContent = 'No game code available';
          statusEl.className = 'status error';
          return;
        }

        statusEl.textContent = 'Attempting to open app...';
        statusEl.className = 'status loading';

        const customSchemeUrl = `tilecribbage://join?code=${gameCode}`;

        // Try custom scheme
        window.location.href = customSchemeUrl;

        // Fallback after 2 seconds if app didn't open
        setTimeout(() => {
          // If user is still on this page, app didn't open
          if (document.hidden === false) {
            statusEl.textContent = 'App not installed. Please download from Google Play.';
            statusEl.className = 'status error';
            appInstalledMsg.style.display = 'none';
            appNotInstalledMsg.style.display = 'inline';
            playWebBtn.style.display = 'inline-block';
          }
        }, 2000);
      });

      // Redirect to Flutter web app
      function redirectToWebApp() {
        if (gameCode) {
          // Flutter web uses hash routing by default
          window.location.href = `https://mmay.dev/tile-cribbage/play/#/online/join?code=${gameCode}`;
        }
      }

      // Auto-attempt on page load
      window.addEventListener('load', () => {
        if (!gameCode) return;

        if (isMobileDevice()) {
          // Mobile: Try native app first
          setTimeout(() => {
            const customSchemeUrl = `tilecribbage://join?code=${gameCode}`;
            window.location.href = customSchemeUrl;

            // If still on page after 2 seconds, show app not installed message
            setTimeout(() => {
              if (document.hidden === false) {
                statusEl.textContent = 'App did not open automatically';
                statusEl.className = 'status error';
                playWebBtn.style.display = 'inline-block';
              }
            }, 2000);
          }, 500);
        } else {
          // Desktop/Web: Redirect to web app immediately
          statusEl.textContent = 'Redirecting to web app...';
          statusEl.className = 'status loading';
          setTimeout(() => {
            redirectToWebApp();
          }, 500);
        }
      });
    </script>
  </body>
</html>
